# =============================================================================
# MeetMind â€” Website Deploy Pipeline (Astro â†’ S3 â†’ CloudFront)
# =============================================================================
# Builds the Astro static site, syncs to S3, invalidates CloudFront cache.
# Replaces previous Docker/ECR/App Runner pipeline.
# =============================================================================
name: ğŸš€ Deploy Website

on:
  push:
    branches: [main]
    paths:
      - "website/**"
      - ".github/workflows/deploy-website.yml"
  workflow_dispatch:

concurrency:
  group: deploy-website
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  S3_BUCKET: aurameet-website
  ROLE_TO_ASSUME: "arn:aws:iam::755400489315:role/aurameet-github-actions"

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build & Deploy to S3 + CloudFront
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: website/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: website
        run: npm ci

      - name: ğŸ—ï¸ Build Astro site
        working-directory: website
        run: npm run build

      - name: ğŸ”§ Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸª£ Sync to S3
        working-directory: website
        run: |
          # Static assets with 1-year immutable cache
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "sitemap*.xml" \
            --exclude "robots.txt"

          # HTML and metadata files with must-revalidate (short cache)
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "*.html" \
            --include "sitemap*.xml" \
            --include "robots.txt"

      - name: ğŸŒ Get CloudFront Distribution ID
        id: cf
        run: |
          DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items[?contains(@,'aurameet.live')]].Id | [0]" \
            --output text)
          echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ CloudFront Distribution: $DIST_ID"

      - name: ğŸ”„ Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.cf.outputs.distribution_id }} \
            --paths "/*"

      - name: ğŸ“¢ Notify Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Website deployed to S3 + CloudFront"
            echo "ğŸŒ https://www.aurameet.live"
          else
            echo "âŒ Deploy failed"
          fi
