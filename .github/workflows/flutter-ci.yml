# =============================================================================
# MeetMind â€” Flutter CI Quality Gate
# =============================================================================
# Runs Flutter analyze, format check, tests, and custom checks on PRs.
# =============================================================================
name: ğŸ“± Flutter CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "flutter_app/**"
      - ".github/workflows/flutter-ci.yml"

concurrency:
  group: flutter-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Flutter Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.41.x"
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Analyze
        run: flutter analyze --no-pub --fatal-infos

      - name: ğŸ¨ Format check
        run: |
          dart format lib/ test/
          if git diff --quiet; then
            echo "âœ… All files formatted correctly"
          else
            echo "âš ï¸ Auto-formatting files to match Dart 3.41.x..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "style(flutter): auto-format to Dart 3.41.x [skip ci]"
            git push
            echo "âœ… Auto-formatted and committed"
          fi

      - name: ğŸ§ª Tests
        run: flutter test

      - name: ğŸš« No dynamic types (CODE-005)
        run: |
          FOUND=$(grep -rn 'dynamic ' lib/ --include='*.dart' \
            | grep -v '// ignore-dynamic' \
            | grep -v 'Map<String, dynamic>' \
            | grep -v 'List<dynamic>' \
            | grep -v 'as dynamic' || true)
          if [ -n "$FOUND" ]; then
            echo "âŒ Found bare 'dynamic' types:"
            echo "$FOUND"
            exit 1
          fi
          echo "âœ… No bare dynamic types found"

      - name: ğŸš« No print() (use debugPrint)
        run: |
          FOUND=$(grep -rn 'print(' lib/ --include='*.dart' \
            | grep -v 'debugPrint' \
            | grep -v '// ignore-print' || true)
          if [ -n "$FOUND" ]; then
            echo "âŒ Found print() â€” use debugPrint or logger:"
            echo "$FOUND"
            exit 1
          fi
          echo "âœ… No print() found"

      - name: ğŸ“ File size check (500 line soft limit)
        run: |
          echo "Files over 500 lines:"
          find lib/ -name "*.dart" -exec sh -c 'lines=$(wc -l < "$1"); if [ "$lines" -gt 500 ]; then echo "  âš ï¸  $1 â€” $lines lines"; fi' _ {} \;
          # Hard limit: 800 lines
          OVER800=$(find lib/ -name "*.dart" -exec sh -c 'lines=$(wc -l < "$1"); if [ "$lines" -gt 800 ]; then echo "$1"; fi' _ {} \;)
          if [ -n "$OVER800" ]; then
            echo "âŒ Files over 800-line hard limit: $OVER800"
            exit 1
          fi

      - name: ğŸ“ PR Comment
        if: github.event_name == 'pull_request' && always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: flutter-ci
          message: |
            ## ğŸ“± Flutter CI â€” ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}
            ğŸ“‹ [Full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
