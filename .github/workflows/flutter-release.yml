# =============================================================================
# MeetMind â€” Flutter Release (APK + IPA)
# =============================================================================
# Triggered on version tags (v*.*.*).
# Android: builds on self-hosted (free).
# iOS: builds on macos-latest (GitHub-hosted, ~15 min macOS runner).
# =============================================================================
name: ðŸ“¦ Flutter Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  android:
    name: ðŸ¤– Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸŒ Generate localizations
        run: flutter gen-l10n

      - name: ðŸ—ï¸ Build APK (release)
        run: |
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=build/debug-info \
            --dart-define=REVENUECAT_ANDROID_KEY=${{ secrets.REVENUECAT_ANDROID_KEY }} \
            --dart-define=SENTRY_DSN=${{ secrets.SENTRY_DSN }}

      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-android-${{ github.ref_name }}
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  ios:
    name: ðŸŽ iOS IPA
    runs-on: macos-latest # Standard GitHub runner (usually macos-12 or 13)
    timeout-minutes: 30
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸŒ Generate localizations
        run: flutter gen-l10n

      - name: ðŸ”‘ Install certificate & API key
        env:
          CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # --- Create temporary keychain ---
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import distribution certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -P "$CERT_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm -f "$CERT_PATH"

          # --- Write API key for xcodebuild auth ---
          mkdir -p ~/private_keys
          echo "$API_KEY" > ~/private_keys/AuthKey_${API_KEY_ID}.p8
          echo "âœ… Certificate + API key installed"

      - name: ðŸ—ï¸ Build & Archive
        run: |
          flutter build ios --release --no-codesign \
            --dart-define=REVENUECAT_IOS_KEY=${{ secrets.REVENUECAT_IOS_KEY }} \
            --dart-define=SENTRY_DSN=${{ secrets.SENTRY_DSN }}

      - name: ðŸ“¦ Archive & Export IPA
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Generate ExportOptions.plist
          cat > ios/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>9L6258YNVJ</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

          # â”€â”€ Step 1: Archive without signing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # GitHub runner can't sign during archive (no dev profiles,
          # account at max certificates). Archive unsigned.
          # iOS 16+ deployment target means Swift Concurrency is
          # built into the OS â€” no libswift_Concurrency.dylib needed.
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/ios/archive/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

          echo "âœ… Archive completed"

          # â”€â”€ Step 2: Create SwiftSupport/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # With iOS 16+ and CODE_SIGNING_ALLOWED=NO, Xcode skips
          # creating SwiftSupport/ (no backport libs needed).
          # But Apple REQUIRES it for any app using Swift frameworks.
          ARCHIVE=build/ios/archive/Runner.xcarchive
          APP="$ARCHIVE/Products/Applications/Runner.app"
          FRAMEWORKS="$APP/Frameworks"
          mkdir -p "$ARCHIVE/SwiftSupport/iphoneos"

          # Diagnostic: show what the archive contains
          echo "ðŸ“¦ Frameworks/ contents:"
          ls "$FRAMEWORKS/" 2>/dev/null | head -10 || echo "  (empty)"

          # â”€â”€ Approach 1: swift-stdlib-tool (official tool) â”€â”€â”€â”€â”€
          # Do NOT use --filter-for-swift-os, as it removes all
          # libs that exist in the OS (= everything for iOS 16+).
          # Only use --unsigned-destination (not --destination) to
          # avoid touching the already-built Frameworks/.
          echo "ðŸ”§ Approach 1: swift-stdlib-tool..."
          xcrun swift-stdlib-tool --copy \
            --verbose \
            --platform iphoneos \
            --toolchain "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain" \
            --scan-executable "$APP/Runner" \
            --scan-folder "$FRAMEWORKS" \
            --unsigned-destination "$ARCHIVE/SwiftSupport/iphoneos" \
            2>&1 || echo "âš ï¸ swift-stdlib-tool exited with $?"

          SUPPORT_COUNT=$(ls "$ARCHIVE/SwiftSupport/iphoneos/"*.dylib 2>/dev/null | wc -l | tr -d ' ')
          echo "  â†’ Found $SUPPORT_COUNT dylibs"

          # â”€â”€ Approach 2: Find dylibs on system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "$SUPPORT_COUNT" = "0" ]; then
            echo "ðŸ”§ Approach 2: Finding Swift dylibs on system..."

            # Find the actual directory containing libswiftCore.dylib
            SWIFT_DYLIB_DIR=$(find "$(xcode-select -p)" \
              -name "libswiftCore.dylib" \
              -path "*/iphoneos/*" \
              -not -path "*/swift-5*" \
              -type f 2>/dev/null | head -1 | xargs dirname 2>/dev/null || true)

            if [ -z "$SWIFT_DYLIB_DIR" ]; then
              # Try alternate paths
              SWIFT_DYLIB_DIR=$(find "$(xcode-select -p)" \
                -name "libswiftCore.dylib" \
                -type f 2>/dev/null | head -1 | xargs dirname 2>/dev/null || true)
            fi

            echo "  Swift dylib dir: ${SWIFT_DYLIB_DIR:-(not found)}"

            if [ -n "$SWIFT_DYLIB_DIR" ]; then
              # Scan frameworks to find which Swift libs are needed
              NEEDED=""
              for fw in "$FRAMEWORKS"/*.framework; do
                if [ -d "$fw" ]; then
                  FW_BIN="$fw/$(basename "$fw" .framework)"
                  [ -f "$FW_BIN" ] && NEEDED="$NEEDED $(otool -L "$FW_BIN" 2>/dev/null | grep -oE 'libswift\w+\.dylib' || true)"
                fi
              done
              [ -f "$APP/Runner" ] && NEEDED="$NEEDED $(otool -L "$APP/Runner" 2>/dev/null | grep -oE 'libswift\w+\.dylib' || true)"

              NEEDED=$(echo "$NEEDED" | tr ' ' '\n' | sort -u | grep -v '^$' || true)
              echo "  Needed libs: $(echo $NEEDED | tr '\n' ' ')"

              for lib in $NEEDED; do
                if [ -f "$SWIFT_DYLIB_DIR/$lib" ]; then
                  cp "$SWIFT_DYLIB_DIR/$lib" "$ARCHIVE/SwiftSupport/iphoneos/"
                  echo "  âœ… $lib"
                fi
              done
            fi

            SUPPORT_COUNT=$(ls "$ARCHIVE/SwiftSupport/iphoneos/"*.dylib 2>/dev/null | wc -l | tr -d ' ')
          fi

          # â”€â”€ Approach 3: Copy core Swift runtime from any path â”€â”€
          if [ "$SUPPORT_COUNT" = "0" ]; then
            echo "ðŸ”§ Approach 3: Copying core Swift runtime from SDK..."
            SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path 2>/dev/null || true)
            echo "  SDK: $SDK_PATH"

            # Try all known paths
            for search_dir in \
              "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphoneos" \
              "$SDK_PATH/usr/lib/swift" \
              "$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift-5.5/iphoneos"; do
              if [ -d "$search_dir" ]; then
                echo "  Checking $search_dir ..."
                ls "$search_dir"/*.dylib 2>/dev/null | head -5 || echo "    (no .dylib files)"
                ls "$search_dir"/*.tbd 2>/dev/null | head -3 || echo "    (no .tbd files)"
                for lib in "$search_dir"/libswift*.dylib; do
                  if [ -f "$lib" ]; then
                    cp "$lib" "$ARCHIVE/SwiftSupport/iphoneos/"
                  fi
                done
              fi
            done

            SUPPORT_COUNT=$(ls "$ARCHIVE/SwiftSupport/iphoneos/"*.dylib 2>/dev/null | wc -l | tr -d ' ')
          fi

          echo "ðŸ“¦ Final SwiftSupport/ ($SUPPORT_COUNT dylibs):"
          ls -la "$ARCHIVE/SwiftSupport/iphoneos/" 2>/dev/null | head -20 || echo "  EMPTY!"

          if [ "$SUPPORT_COUNT" = "0" ]; then
            echo "âŒ ERROR: Could not populate SwiftSupport!"
            echo "Debug: listing all libswiftCore locations on system..."
            find "$(xcode-select -p)" -name "libswiftCore*" -type f 2>/dev/null || echo "  None found!"
            exit 1
          fi

          # â”€â”€ Step 3: Export IPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath build/ios/ipa \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID"

          echo "âœ… IPA exported successfully"

      - name: ðŸ“¤ Upload IPA (artifact backup)
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-ios-${{ github.ref_name }}
          path: flutter_app/build/ios/ipa/*.ipa
          retention-days: 90

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf ~/private_keys
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true

  notify:
    name: ðŸ”” Release Notification
    needs: [android, ios]
    runs-on: [self-hosted, linux, meetmind]
    if: always()
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ANDROID="${{ needs.android.result }}"
          IOS="${{ needs.ios.result }}"
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ðŸ“¦ *MeetMind Release ${{ github.ref_name }}*\nâ€¢ Android: $ANDROID\nâ€¢ iOS + TestFlight: $IOS\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline>\"
            }"
