# =============================================================================
# MeetMind â€” Flutter Release (APK + IPA)
# =============================================================================
# Triggered on version tags (v*.*.*).
# Android: builds on self-hosted (free).
# iOS: builds on macos-latest (GitHub-hosted, ~15 min macOS runner).
# =============================================================================
name: ðŸ“¦ Flutter Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  android:
    name: ðŸ¤– Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸŒ Generate localizations
        run: flutter gen-l10n

      - name: ðŸ—ï¸ Build APK (release)
        run: |
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=build/debug-info \
            --dart-define=REVENUECAT_ANDROID_KEY=${{ secrets.REVENUECAT_ANDROID_KEY }} \
            --dart-define=SENTRY_DSN=${{ secrets.SENTRY_DSN }}

      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-android-${{ github.ref_name }}
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  ios:
    name: ðŸŽ iOS IPA
    runs-on: macos-15
    timeout-minutes: 30
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: ðŸ› ï¸ Select Xcode 26
        run: |
          sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          xcodebuild -version
          xcrun --sdk iphoneos --show-sdk-version

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸŒ Generate localizations
        run: flutter gen-l10n

      - name: ðŸ”‘ Install certificate & API key
        env:
          CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # --- Create temporary keychain ---
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import distribution certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -P "$CERT_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm -f "$CERT_PATH"

          # --- Write API key for xcodebuild auth ---
          mkdir -p ~/private_keys
          echo "$API_KEY" > ~/private_keys/AuthKey_${API_KEY_ID}.p8
          echo "âœ… Certificate + API key installed"

      - name: ðŸ—ï¸ Build Dart code
        run: |
          flutter build ios --release --no-codesign \
            --dart-define=REVENUECAT_IOS_KEY=${{ secrets.REVENUECAT_IOS_KEY }} \
            --dart-define=SENTRY_DSN=${{ secrets.SENTRY_DSN }}

      - name: ðŸ“¦ Archive & Export IPA
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Generate ExportOptions.plist
          cat > ios/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>9L6258YNVJ</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          PLIST

          rm -rf build/ios/archive

          # â”€â”€ Step 1: Archive (unsigned â€” proven to compile) â”€â”€â”€â”€â”€â”€â”€â”€â”€
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/ios/archive/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

          echo "âœ… Archive completed"

          # â”€â”€ Step 2: Inject SwiftSupport/ into archive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # The unsigned archive has no SwiftSupport/. We use
          # swift-stdlib-tool to scan ONLY the Runner.app binary and
          # copy the required Swift dylibs into SwiftSupport/.
          ARCHIVE="build/ios/archive/Runner.xcarchive"
          APP="$ARCHIVE/Products/Applications/Runner.app"
          SWIFT_SUPPORT="$ARCHIVE/SwiftSupport/iphoneos"
          TOOLCHAIN="$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain"

          echo "ðŸ“¦ Frameworks/ in app:"
          ls "$ARCHIVE/Products/Applications/Runner.app/Frameworks/" 2>/dev/null | head -20 || echo "  (empty)"

          # â”€â”€ Step 2: Export IPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath build/ios/ipa \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${API_KEY_ID}.p8 \
            -authenticationKeyID "$API_KEY_ID" \
            -authenticationKeyIssuerID "$API_ISSUER_ID"

          echo "âœ… IPA exported"

          # â”€â”€ Step 3: Inject SwiftSupport/ INTO the IPA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # xcodebuild -exportArchive strips SwiftSupport/ from archive.
          # We inject it directly into the .ipa ZIP file after export.
          IPA=$(ls build/ios/ipa/*.ipa 2>/dev/null | head -1)
          TOOLCHAIN="$(xcode-select -p)/Toolchains/XcodeDefault.xctoolchain"
          APP="$ARCHIVE/Products/Applications/Runner.app"

          if [ -n "$IPA" ]; then
            echo "ðŸ“¦ IPA before injection:"
            unzip -l "$IPA" | grep -i "SwiftSupport" | head -5 || echo "  (none)"

            # Create SwiftSupport dir
            WORKDIR=$(mktemp -d)
            mkdir -p "$WORKDIR/SwiftSupport/iphoneos"

            # Use swift-stdlib-tool to find required dylibs
            xcrun swift-stdlib-tool \
              --copy \
              --scan-executable "$APP/Runner" \
              --scan-folder "$APP/Frameworks" \
              --platform iphoneos \
              --toolchain "$TOOLCHAIN" \
              --unsigned-destination "$WORKDIR/SwiftSupport/iphoneos" \
              --filter-for-swift-os \
              --back-deploy-swift-concurrency \
              --back-deploy-swift-span 2>&1 || true

            # Fallback: if empty, copy compatibility dylib
            if [ -z "$(ls -A "$WORKDIR/SwiftSupport/iphoneos" 2>/dev/null)" ]; then
              echo "â„¹ï¸ swift-stdlib-tool found no dylibs, using fallback..."
              # Copy ALL Swift dylibs from Frameworks/ that exist in toolchain
              for fw in "$APP/Frameworks"/libswift*.dylib; do
                if [ -f "$fw" ]; then
                  BASENAME=$(basename "$fw")
                  # Look for this dylib in toolchain
                  TOOLCHAIN_LIB="$TOOLCHAIN/usr/lib/swift/iphoneos/$BASENAME"
                  TOOLCHAIN_LIB2="$TOOLCHAIN/usr/lib/swift-6.2/iphoneos/$BASENAME"
                  if [ -f "$TOOLCHAIN_LIB" ]; then
                    cp "$TOOLCHAIN_LIB" "$WORKDIR/SwiftSupport/iphoneos/"
                    echo "  âœ… Copied $BASENAME (from swift/)"
                  elif [ -f "$TOOLCHAIN_LIB2" ]; then
                    cp "$TOOLCHAIN_LIB2" "$WORKDIR/SwiftSupport/iphoneos/"
                    echo "  âœ… Copied $BASENAME (from swift-6.2/)"
                  fi
                fi
              done

              # If still empty, copy compatibility span as minimum
              if [ -z "$(ls -A "$WORKDIR/SwiftSupport/iphoneos" 2>/dev/null)" ]; then
                COMPAT="$TOOLCHAIN/usr/lib/swift-6.2/iphoneos/libswiftCompatibilitySpan.dylib"
                if [ -f "$COMPAT" ]; then
                  cp "$COMPAT" "$WORKDIR/SwiftSupport/iphoneos/"
                  echo "  âœ… Added libswiftCompatibilitySpan.dylib (minimum)"
                fi
              fi
            fi

            echo "ðŸ“¦ SwiftSupport to inject:"
            ls -la "$WORKDIR/SwiftSupport/iphoneos/" 2>/dev/null

            # Inject into IPA (IPA is a ZIP file)
            cd "$WORKDIR"
            zip -r "$OLDPWD/$IPA" SwiftSupport/
            cd "$OLDPWD"
            rm -rf "$WORKDIR"

            echo "ðŸ“¦ IPA after injection:"
            unzip -l "$IPA" | grep -i "SwiftSupport" | head -10 || echo "  âš ï¸ STILL NOT IN IPA"
          fi

          echo "âœ… IPA ready for upload"

      - name: ðŸ“¤ Upload IPA (artifact backup)
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-ios-${{ github.ref_name }}
          path: flutter_app/build/ios/ipa/*.ipa
          retention-days: 90

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf ~/private_keys
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true

  notify:
    name: ðŸ”” Release Notification
    needs: [android, ios]
    runs-on: [self-hosted, linux, meetmind]
    if: always()
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ANDROID="${{ needs.android.result }}"
          IOS="${{ needs.ios.result }}"
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ðŸ“¦ *MeetMind Release ${{ github.ref_name }}*\nâ€¢ Android: $ANDROID\nâ€¢ iOS + TestFlight: $IOS\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline>\"
            }"
