# =============================================================================
# MeetMind ‚Äî Flutter Release (APK + IPA)
# =============================================================================
# Triggered on version tags (v*.*.*).
# Android: builds on self-hosted (free).
# iOS: builds on macos-latest (GitHub-hosted, ~15 min macOS runner).
# =============================================================================
name: üì¶ Flutter Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  android:
    name: ü§ñ Android APK
    runs-on: [self-hosted, linux, meetmind]
    timeout-minutes: 20
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.x"
          channel: stable
          cache: true

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üèóÔ∏è Build APK (release)
        run: |
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=build/debug-info

      - name: üì§ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-android-${{ github.ref_name }}
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  ios:
    name: üçé iOS IPA
    runs-on: macos-latest # GitHub-hosted (only on tags to conserve minutes)
    timeout-minutes: 30
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.x"
          channel: stable
          cache: true

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üîë Install distribution certificate
        env:
          CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$CERT_BASE64" | base64 --decode > "$CERT_PATH"

          security import "$CERT_PATH" \
            -P "$CERT_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Add keychain to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Cleanup temp cert
          rm -f "$CERT_PATH"
          echo "‚úÖ Distribution certificate installed"

      - name: üìã Generate ExportOptions.plist
        run: |
          cat > ios/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>destination</key>
            <string>upload</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>9L6258YNVJ</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF
          echo "‚úÖ ExportOptions.plist generated"

      - name: üèóÔ∏è Build IPA (release)
        run: |
          flutter build ipa \
            --release \
            --export-options-plist=ios/ExportOptions.plist

      - name: ü©π Patch MinimumOSVersion (Xcode 16 fix)
        run: |
          ARCHIVE=$(find build/ios/archive -name "*.xcarchive" 2>/dev/null | head -1)
          if [ -n "$ARCHIVE" ]; then
            PLIST="$ARCHIVE/Products/Applications/Runner.app/Frameworks/App.framework/Info.plist"
            if [ -f "$PLIST" ]; then
              plutil -replace MinimumOSVersion -string "13.0" "$PLIST"
              echo "‚úÖ Patched MinimumOSVersion to 13.0"
            fi
          fi

      - name: üì§ Upload IPA (artifact backup)
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-ios-${{ github.ref_name }}
          path: flutter_app/build/ios/ipa/*.ipa
          retention-days: 90

      - name: üöÄ Upload to TestFlight
        env:
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          # Write API key to temp file
          KEY_FILE=$(mktemp)
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" > "$KEY_FILE"

          IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå No IPA found!"
            rm -f "$KEY_FILE"
            exit 1
          fi

          echo "üì¶ Validating IPA..."
          xcrun altool --validate-app \
            --file "$IPA_PATH" \
            --type ios \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --private-key "$KEY_FILE"

          echo "üöÄ Uploading to TestFlight..."
          xcrun altool --upload-app \
            --file "$IPA_PATH" \
            --type ios \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --private-key "$KEY_FILE"

          # Cleanup
          rm -f "$KEY_FILE"
          echo "‚úÖ IPA uploaded to TestFlight!"

  notify:
    name: üîî Release Notification
    needs: [android, ios]
    runs-on: [self-hosted, linux, meetmind]
    if: always()
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ANDROID="${{ needs.android.result }}"
          IOS="${{ needs.ios.result }}"
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"üì¶ *MeetMind Release ${{ github.ref_name }}*\n‚Ä¢ Android: $ANDROID\n‚Ä¢ iOS + TestFlight: $IOS\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline>\"
            }"
