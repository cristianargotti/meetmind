# =============================================================================
# MeetMind â€” Flutter Release (APK + IPA)
# =============================================================================
# Triggered on version tags (v*.*.*).
# Android: builds on self-hosted (free).
# iOS: builds on macos-latest (GitHub-hosted, ~15 min macOS runner).
# =============================================================================
name: ðŸ“¦ Flutter Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  android:
    name: ðŸ¤– Android APK
    runs-on: [self-hosted, linux, meetmind]
    timeout-minutes: 20
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.x"
          channel: stable
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build APK (release)
        run: |
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=build/debug-info

      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-android-${{ github.ref_name }}
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  ios:
    name: ðŸŽ iOS IPA
    runs-on: macos-latest # GitHub-hosted (only on tags to conserve minutes)
    timeout-minutes: 30
    defaults:
      run:
        working-directory: flutter_app

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.x"
          channel: stable
          cache: true

      - name: ðŸ“¦ Get dependencies
        run: flutter pub get

      - name: ðŸ—ï¸ Build IPA (release)
        run: |
          flutter build ipa \
            --release \
            --export-options-plist=ios/ExportOptions.plist 2>/dev/null || \
          flutter build ipa --release

      - name: ðŸ©¹ Patch MinimumOSVersion (Xcode 16 fix)
        run: |
          ARCHIVE=$(find build/ios/archive -name "*.xcarchive" 2>/dev/null | head -1)
          if [ -n "$ARCHIVE" ]; then
            PLIST="$ARCHIVE/Products/Applications/Runner.app/Frameworks/App.framework/Info.plist"
            if [ -f "$PLIST" ]; then
              plutil -replace MinimumOSVersion -string "13.0" "$PLIST"
              echo "âœ… Patched MinimumOSVersion to 13.0"
            fi
          fi

      - name: ðŸ“¤ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: meetmind-ios-${{ github.ref_name }}
          path: flutter_app/build/ios/ipa/*.ipa
          retention-days: 90

  notify:
    name: ðŸ”” Release Notification
    needs: [android, ios]
    runs-on: [self-hosted, linux, meetmind]
    if: always()
    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          ANDROID="${{ needs.android.result }}"
          IOS="${{ needs.ios.result }}"
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"ðŸ“¦ *MeetMind Release ${{ github.ref_name }}*\nâ€¢ Android: $ANDROID\nâ€¢ iOS: $IOS\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Download Artifacts>\"
            }"
