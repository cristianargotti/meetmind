# =============================================================================
# AuraMeet ‚Äî Terraform Apply (Production)
# =============================================================================
# Applies Terraform changes after merge to main.
# Uses 'production' environment for manual approval gate.
#
# Required GitHub Secrets:
#   - MEETMIND_OPENAI_API_KEY
#   - AURAMEET_JWT_SECRET_KEY
#   - AURAMEET_DB_PASSWORD
#   - AURAMEET_GOOGLE_CLIENT_ID (optional)
#   - AURAMEET_SENTRY_DSN (optional)
#   - SLACK_WEBHOOK_URL (optional)
# =============================================================================
name: üèóÔ∏è Terraform Apply

on:
  push:
    branches: [main]
    paths:
      - "infra/**"
      - ".github/workflows/terraform-apply.yml"
  workflow_dispatch:

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  apply:
    name: Terraform Apply
    runs-on: [self-hosted, linux, meetmind]
    timeout-minutes: 30
    environment: production # Manual approval required

    # Inject secrets via TF_VAR_ environment variables
    env:
      TF_VAR_openai_api_key: ${{ secrets.MEETMIND_OPENAI_API_KEY }}
      TF_VAR_jwt_secret_key: ${{ secrets.AURAMEET_JWT_SECRET_KEY }}
      TF_VAR_db_password: ${{ secrets.AURAMEET_DB_PASSWORD }}
      TF_VAR_google_client_id: ${{ secrets.AURAMEET_GOOGLE_CLIENT_ID }}
      TF_VAR_sentry_dsn: ${{ secrets.AURAMEET_SENTRY_DSN }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß AWS credentials (EC2 instance profile)
        run: aws sts get-caller-identity

      - name: üèóÔ∏è Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: üìã Terraform Init
        working-directory: infra/environments/production
        run: |
          # Override backend profile (CI uses EC2 instance profile, not named profile)
          terraform init -input=false \
            -backend-config="profile="

      - name: üìä Terraform Plan
        working-directory: infra/environments/production
        env:
          # Override provider profile ‚Äî CI uses EC2 instance profile
          TF_VAR_aws_profile: ""
        run: terraform plan -no-color -input=false -out=tfplan

      - name: üöÄ Terraform Apply
        working-directory: infra/environments/production
        env:
          TF_VAR_aws_profile: ""
        run: terraform apply -auto-approve tfplan

      - name: üîî Notify Slack
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          EMOJI=$([[ "$STATUS" == "success" ]] && echo "‚úÖ" || echo "‚ùå")
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$EMOJI *Terraform Apply* ‚Äî $STATUS\n‚Ä¢ Commit: \`${{ github.sha }}\`\n‚Ä¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"}"
