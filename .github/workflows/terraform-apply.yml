# =============================================================================
# MeetMind â€” Terraform Apply
# =============================================================================
# Applies Terraform changes after merge to main.
# Uses 'production' environment for manual approval gate.
#
# Required GitHub Secrets:
#   - MEETMIND_OPENAI_API_KEY: OpenAI API key (reused from backend deploy)
#   - SLACK_WEBHOOK_URL: (optional) Slack notifications
# =============================================================================
name: ğŸ—ï¸ Terraform Apply

on:
  push:
    branches: [main]
    paths:
      - "infra/**"
      - ".github/workflows/terraform-apply.yml"
  workflow_dispatch:

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  apply:
    name: Terraform Apply
    runs-on: [self-hosted, linux, meetmind]
    timeout-minutes: 30
    environment: production # Manual approval required

    # Inject secrets via TF_VAR_ environment variables
    # Terraform auto-reads TF_VAR_<name> as variable values
    env:
      TF_VAR_openai_api_key: ${{ secrets.MEETMIND_OPENAI_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ AWS credentials (EC2 instance profile)
        run: aws sts get-caller-identity

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: ğŸ“‹ Terraform Init
        working-directory: infra/environments/production
        run: terraform init -input=false

      - name: ğŸ“Š Terraform Plan
        working-directory: infra/environments/production
        run: terraform plan -no-color -input=false -out=tfplan

      - name: ğŸš€ Terraform Apply
        working-directory: infra/environments/production
        run: terraform apply -auto-approve tfplan

      - name: ğŸ”” Notify Slack
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          EMOJI=$([[ "$STATUS" == "success" ]] && echo "âœ…" || echo "âŒ")
          curl -s -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"$EMOJI *Terraform Apply* â€” $STATUS\nâ€¢ Commit: \`${{ github.sha }}\`\nâ€¢ <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\"}"
